<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Items — Color & Seasons (placeCategories only)</title>

 
    
  <style>
    :root{
      /* neutral greys with subtle green accents */
      --bg:#0b0c0c;
      --card:#0f1111;
      --muted:#9aa0a0;
      --text:#e6e9e8;
      --surface:#121414;
      --chip-bg:rgba(255,255,255,0.02);
      --chip-border:#2f6b3a70;
      --place-chip-bg:rgba(255,255,255,0.015);
      --place-chip-border:rgba(255,255,255,0.02);

      /* green used sparingly */
      --accent:#2f6b3a;       /* touch accent */
      --accent-strong:rgba(47,107,58,0.95);
      --focus-ring:rgba(47,107,58,0.14);

      --gap:10px;
      --img-size:88px;
      --max-width:920px;
      --radius:10px;
      --shadow:0 6px 18px rgba(0,0,0,0.6);
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:var(--max-width);margin:18px auto;padding:12px}
    h1{margin:0 0 8px 0;font-size:1.15rem;color:var(--text)}

    .card{background:linear-gradient(180deg, rgba(18,19,18,0.6), var(--card));padding:12px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.01)}
    .controls-row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px}

    .chip-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:999px;border:1px solid var(--chip-border);background:var(--chip-bg);color:var(--muted);cursor:default;font-size:0.92rem}
    .chip.selectable{cursor:pointer;outline-offset:3px}
    .chip.selectable:hover{box-shadow:0 4px 10px rgba(0,0,0,0.35)}
    .chip.selectable:focus{box-shadow:0 0 0 4px var(--focus-ring)}
    .chip.selectable.active{background:var(--accent-strong);color:var(--text);border-color:transparent;box-shadow:0 8px 18px rgba(0,0,0,0.45)}

    .place-pinned .chip{background:var(--place-chip-bg);border-color:var(--place-chip-border);color:var(--muted)}
    .pinned-close{margin-left:8px;font-weight:700;opacity:0.85;cursor:pointer;color:var(--muted)}

    .results{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .result-item{display:flex;gap:var(--gap);align-items:flex-start;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008))}
    .result-image{width:var(--img-size); height:var(--img-size); flex:0 0 var(--img-size); border-radius:8px; background:linear-gradient(135deg,#0e0f0e,#161816); display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.02);}   
    .result-image img{max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; display:block;}
    .fallback-icon{width:100%;height:100%;display:inline-block;background:linear-gradient(180deg,#dfe7df,#cfded0);border-radius:6px}

    .result-body{flex:1;display:flex;flex-direction:column;gap:8px}
    .result-title{font-weight:700;font-size:0.98rem;line-height:1.1;color:var(--text)}
    .tag-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .item-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #2f6b3a70;background:transparent;font-size:0.82rem;color:var(--text);cursor:default}
    .item-chip.clickable{cursor:pointer;opacity:0.95}
    .item-chip.clickable:hover{transform:translateY(-1px)}

    .dropdown-panel{display:none;position:absolute;z-index:40;padding:10px;border-radius:8px;background:linear-gradient(180deg,#0a0b0a,#050605);box-shadow:0 8px 30px rgba(0,0,0,0.6);max-width:360px}
    .dropdown-panel input{width:100%;padding:6px 8px;margin-bottom:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
    .dropdown-panel .chip{margin:2px}

    .status{color:var(--muted);font-size:0.9rem}
    button.primary{background:var(--accent);color:white;border:0;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:0.9rem}
    @media (max-width:720px){ :root{--img-size:72px} .wrap{padding:10px} }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card" aria-labelledby="filters-heading">
      <div id="filters-heading" style="font-weight:600;margin-bottom:8px;color:var(--muted)"></div>

      <div class="filters" role="region" aria-label="Filter groups">
        <div class="filter-group" aria-labelledby="color-label" style="margin-bottom:10px">
          <div id="color-label" style="color:var(--muted);font-size:0.9rem"><strong>Basic Mats:</strong></div>
          <div id="colorChips" class="chip-row" role="list" aria-label="Color filters"></div>
        </div>

        <div class="filter-group" aria-labelledby="place-label">
          <div id="place-label" style="color:var(--muted);font-size:0.9rem"><strong>Advanced Mats:</strong></div>

          <div id="pinnedPlaces" class="chip-row place-pinned" style="margin:6px 0 8px 0" aria-hidden="false"></div>

          <div id="seasonChips" class="chip-row" role="list" aria-label="Season groups"></div>

          <div id="seasonDropdown" class="dropdown-panel" role="dialog" aria-modal="false" aria-hidden="true">
            <input id="seasonSearch" type="search" placeholder="Search categories" aria-label="Search categories" />
            <div id="seasonList" style="max-height:240px;overflow:auto;display:flex;flex-wrap:wrap;gap:6px;"></div>
          </div>
        </div>

        <div class="controls-row">
          <div class="status" id="status" aria-live="polite">Loading…</div>
          <div><button id="clear" class="primary" aria-label="Clear filters">Clear</button></div>
        </div>
      </div>

      <div id="results" class="results" aria-live="polite"></div>
    </div>
  </div>

  <script>
    const ITEMS_JSON = 'items.json';

    let ITEMS = [];
    let ITEMS_NORMALIZED = [];
    let SEASONS = {};
    const activeColors = new Set();
    const activePlaces = new Set();

    const els = {
      colorChips: document.getElementById('colorChips'),
      seasonChips: document.getElementById('seasonChips'),
      pinnedPlaces: document.getElementById('pinnedPlaces'),
      seasonDropdown: document.getElementById('seasonDropdown'),
      seasonSearch: document.getElementById('seasonSearch'),
      seasonList: document.getElementById('seasonList'),
      clearBtn: document.getElementById('clear'),
      results: document.getElementById('results'),
      status: document.getElementById('status')
    };

    const esc = s => String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const uniqSorted = arr => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b));

    async function loadItems(){
      try{
        const res = await fetch(ITEMS_JSON, {cache:'no-cache'});
        if(!res.ok) throw new Error('Failed to load ' + ITEMS_JSON + ' (' + res.status + ')');
        ITEMS = await res.json();
        if(!Array.isArray(ITEMS)) throw new Error('items.json must be an array');
        normalizeItems();
        const sets = buildFilterSets();
        renderFilterChips(els.colorChips, sets.colors, toggleColor, activeColors);
        SEASONS = sets.seasons;
        renderSeasonChips(SEASONS);
        renderPinnedPlaces();
        applyFilters();
        els.status.textContent = `${ITEMS_NORMALIZED.length} item(s)`;
      }catch(err){
        console.error(err);
        els.status.textContent = 'Error loading items.json';
        els.results.innerHTML = '<div style="color:#c00">Could not load items.json</div>';
      }
    }

    function normalizeItems(){
      ITEMS_NORMALIZED = ITEMS.map(it => ({
        ...it,
        color: Array.isArray(it.color) ? it.color : (it.color ? [it.color] : []),
        placeCategories: Array.isArray(it.placeCategories) ? it.placeCategories : []
      }));
    }

    function buildFilterSets(){
      const colors = [];
      const seasons = {};
      ITEMS_NORMALIZED.forEach(it=>{
        (it.color || []).forEach(c=> colors.push(c));
        (it.placeCategories || []).forEach(pc=>{
          const s = pc.season || 'All Seasons';
          const cat = (pc.category || '').trim();
          if(!cat) return;
          seasons[s] = seasons[s] || new Set();
          seasons[s].add(cat);
        });
      });
      return {
        colors: uniqSorted(colors),
        seasons: Object.fromEntries(Object.entries(seasons).map(([k,s]) => [k, uniqSorted(Array.from(s))]))
      };
    }

    function renderFilterChips(container, items, onToggle, activeSet){
      container.innerHTML = '';
      items.forEach(val=>{
        const b = document.createElement('button');
        b.type='button';
        b.className='chip selectable' + (activeSet && activeSet.has(val) ? ' active' : '');
        b.tabIndex=0;
        b.setAttribute('aria-pressed', activeSet && activeSet.has(val) ? 'true' : 'false');
        b.innerHTML = `<span>${esc(val)}</span>`;
        b.addEventListener('click', ()=> onToggle(val,b));
        b.addEventListener('keydown', e=> { if(e.key==='Enter'||e.key===' '){ e.preventDefault(); b.click(); }});
        container.appendChild(b);
      });
    }

    function toggleColor(color, btn){
      if(activeColors.has(color)){
        activeColors.delete(color);
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed','false');
      } else {
        activeColors.add(color);
        btn.classList.add('active');
        btn.setAttribute('aria-pressed','true');
      }
      applyFilters();
    }

    let openSeason = null;
    function renderSeasonChips(seasonsObj){
      els.seasonChips.innerHTML = '';
      Object.keys(seasonsObj).forEach(season=>{
        const b = document.createElement('button');
        b.type='button';
        b.className='chip selectable';
        b.textContent = season;
        b.addEventListener('click', e=> { toggleSeasonDropdown(season, b); e.stopPropagation(); });
        els.seasonChips.appendChild(b);
      });
    }

    function viewportOffsetFor(btn){
      const r = btn.getBoundingClientRect();
      return {top: r.bottom + window.scrollY + 6, left: Math.max(8, r.left + window.scrollX)};
    }

    function toggleSeasonDropdown(season, btn){
      if(openSeason === season){ closeSeasonDropdown(); return; }
      openSeason = season;
      const pos = viewportOffsetFor(btn);
      els.seasonDropdown.style.top = pos.top + 'px';
      els.seasonDropdown.style.left = pos.left + 'px';
      els.seasonDropdown.style.display = 'block';
      els.seasonDropdown.setAttribute('aria-hidden','false');
      els.seasonSearch.value = '';
      renderSeasonList(season);
      els.seasonSearch.focus();
    }

    function closeSeasonDropdown(){
      els.seasonDropdown.style.display = 'none';
      els.seasonDropdown.setAttribute('aria-hidden','true');
      openSeason = null;
    }

    function renderSeasonList(season){
      els.seasonList.innerHTML = '';
      const cats = SEASONS[season] || [];
      cats.forEach(cat=>{
        const b = document.createElement('button');
        b.type='button';
        b.className = 'chip selectable' + (activePlaces.has(cat) ? ' active' : '');
        b.style.margin='2px';
        b.innerHTML = `<span>${esc(cat)}</span>`;
        b.addEventListener('click', ()=>{
          togglePlaceByName(cat);
          renderSeasonList(season);
        });
        els.seasonList.appendChild(b);
      });
    }

    let searchTimer = 0;
    els.seasonSearch.addEventListener('input', ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>{
        const q = els.seasonSearch.value.trim().toLowerCase();
        Array.from(els.seasonList.children).forEach(btn=>{
          const txt = btn.textContent.trim().toLowerCase();
          btn.style.display = (!q || txt.includes(q)) ? 'inline-flex' : 'none';
        });
      }, 120);
    });

    function renderPinnedPlaces(){
      els.pinnedPlaces.innerHTML = '';
      Array.from(activePlaces).forEach(cat=>{
        const c = document.createElement('div');
        c.className = 'chip selectable active';
        c.style.padding='4px 8px';
        c.textContent = cat;
        const x = document.createElement('span');
        x.textContent = '×';
        x.className = 'pinned-close';
        x.setAttribute('role','button');
        x.tabIndex = 0;
        x.addEventListener('click', (e)=>{ togglePlaceByName(cat); e.stopPropagation(); });
        x.addEventListener('keydown', e => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); togglePlaceByName(cat); } });
        c.appendChild(x);
        els.pinnedPlaces.appendChild(c);
      });
    }

    function togglePlaceByName(cat){
      if(activePlaces.has(cat)) activePlaces.delete(cat);
      else activePlaces.add(cat);

      document.querySelectorAll('#seasonList .chip').forEach(btn=>{
        if(btn.textContent.trim() === cat){
          btn.classList.toggle('active', activePlaces.has(cat));
          btn.setAttribute('aria-pressed', activePlaces.has(cat) ? 'true' : 'false');
        }
      });

      renderPinnedPlaces();
      applyFilters();
    }

    document.addEventListener('click', (e)=> {
      if(!els.seasonDropdown.contains(e.target) && !els.seasonChips.contains(e.target)) closeSeasonDropdown();
    });
    document.addEventListener('keydown', e=> { if(e.key === 'Escape') closeSeasonDropdown(); });

    function applyFilters(){
      const colorsActive = activeColors.size > 0;
      const placesActive = activePlaces.size > 0;

      const filtered = ITEMS_NORMALIZED.filter(item=>{
        if(colorsActive){
          for(const c of activeColors) if(!item.color.includes(c)) return false;
        }
        if(placesActive){
          const cats = (item.placeCategories || []).map(pc => pc.category).filter(Boolean);
          const hasOne = cats.some(a => activePlaces.has(a));
          if(!hasOne) return false;
        }
        return true;
      });

      renderResults(filtered);
    }

    function renderResults(items){
      els.results.innerHTML = '';
      els.status.textContent = items.length ? `${items.length} result(s)` : 'No matches';
      if(!items.length){
        const e = document.createElement('div'); e.className='status'; e.textContent='No items match your filters.'; els.results.appendChild(e);
        return;
      }

      items.forEach(it=>{
        const row = document.createElement('div'); row.className='result-item';
        const imgWrap = document.createElement('div'); imgWrap.className='result-image';
        if(it.image){
          const img = document.createElement('img'); img.alt = it.name || '';
          img.src = it.image;
          img.addEventListener('error', ()=> { const fb=document.createElement('span'); fb.className='fallback-icon'; if(img.parentNode) img.replaceWith(fb); });
          imgWrap.appendChild(img);
        } else {
          const fb = document.createElement('span'); fb.className='fallback-icon'; imgWrap.appendChild(fb);
        }

        const body = document.createElement('div'); body.className='result-body';
        const title = document.createElement('div'); title.className='result-title'; title.textContent = it.name || 'Untitled';

        const tagRow = document.createElement('div'); tagRow.className = 'tag-row';

        (it.color || []).forEach(col=>{
          const cchip = document.createElement('div');
          cchip.className = 'item-chip clickable';
          cchip.textContent = col;
          cchip.title = `Filter by color: ${col}`;
          cchip.addEventListener('click', ()=> {
            document.querySelectorAll('#colorChips .chip').forEach(btn => { if(btn.textContent.trim() === col) btn.click(); });
          });
          tagRow.appendChild(cchip);
        });

        const cats = (it.placeCategories || []).map(pc => pc.category).filter(Boolean);
        cats.forEach(cat=>{
          const pchip = document.createElement('div');
          pchip.className = 'item-chip clickable';
          pchip.textContent = cat;
          pchip.title = `Toggle category: ${cat}`;
          pchip.addEventListener('click', ()=> togglePlaceByName(cat));
          tagRow.appendChild(pchip);
        });

        body.appendChild(title);
        body.appendChild(tagRow);
        row.appendChild(imgWrap);
        row.appendChild(body);
        els.results.appendChild(row);
      });
    }

    function clearFilters(){
      activeColors.clear();
      activePlaces.clear();
      document.querySelectorAll('.chip.selectable').forEach(c=>{ c.classList.remove('active'); c.setAttribute('aria-pressed','false'); });
      renderPinnedPlaces();
      applyFilters();
    }
    els.clearBtn.addEventListener('click', clearFilters);

    loadItems();

    window._debug = {
      getState: ()=> ({ ITEMS, ITEMS_NORMALIZED, SEASONS, activeColors:Array.from(activeColors), activePlaces:Array.from(activePlaces) })
    };
  </script>
</body>
</html>
